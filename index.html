<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A4 Promotion Generator (Cloud)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* CSS styles are unchanged from the previous version... */
        :root{--primary-color:#0d1117;--secondary-color:#161b22;--accent-color:#2f81f7;--text-color:#c9d1d9;--text-muted:#8b949e;--border-color:#30363d;--success-color:#238636;--error-color:#da3633}body{font-family:'Inter',sans-serif;background-color:var(--primary-color);color:var(--text-color);margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;gap:30px}.app-container{background-color:var(--secondary-color);border:1px solid var(--border-color);border-radius:8px;padding:24px;width:100%;max-width:500px;box-shadow:0 4px 12px rgba(0,0,0,.2)}h1{text-align:center;margin-top:0;color:#fff;font-weight:700;border-bottom:1px solid var(--border-color);padding-bottom:16px}.form-group{margin-bottom:16px}label{display:block;font-weight:700;margin-bottom:6px;font-size:.9em;color:var(--text-muted)}input[type=text],input[type=number]{width:100%;padding:10px;background-color:var(--primary-color);border:1px solid var(--border-color);border-radius:6px;color:var(--text-color);font-size:1em;box-sizing:border-box;transition:border-color .2s,box-shadow .2s}input:focus{outline:0;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(47,129,247,.3)}#item-name-display{background-color:var(--primary-color);padding:10px;margin-top:8px;border-radius:6px;min-height:20px;font-style:italic;color:var(--text-muted);transition:color .2s}#item-name-display.error{color:var(--error-color)!important;font-style:normal!important}.price-container{display:flex;gap:16px}button{width:100%;padding:12px;font-size:1.1em;font-weight:700;border-radius:6px;border:none;cursor:pointer;transition:background-color .2s,transform .1s}button:disabled{background-color:#8b949e;cursor:not-allowed}#generate-btn{background-color:var(--accent-color);color:#fff}#generate-btn:hover:not(:disabled){background-color:#4092ff}#generate-btn:active:not(:disabled){transform:scale(.98)}#print-btn{background-color:var(--success-color);color:#fff}#print-btn:hover{background-color:#389445}#print-btn:active{transform:scale(.98)}.hidden{display:none!important}#a4-preview-container{width:100%;display:flex;flex-direction:column;align-items:center;gap:20px}.a4-page{width:210mm;height:297mm;transform:scale(.35);transform-origin:top center;margin-bottom:-193mm;background-color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.3);color:#111;display:flex;flex-direction:column;padding:18mm;box-sizing:border-box;position:relative;overflow:hidden}.a4-page .promo-header{font-size:100pt;font-weight:900;text-transform:uppercase;color:#f0f0f0;position:absolute;top:20mm;left:-5mm;z-index:1}.a4-page .main-content{flex-grow:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;position:relative;z-index:2}.a4-page .item-name{font-size:48pt;font-weight:700;line-height:1.1;margin-bottom:10mm;max-width:80%}.a4-page .price-display{display:flex;align-items:baseline;gap:8mm;margin-top:10mm}.a4-page .old-price{font-size:40pt;font-weight:400;color:#999;text-decoration:line-through;text-decoration-thickness:3px}.a4-page .new-price{font-size:110pt;font-weight:900;line-height:1;color:var(--accent-color)}.a4-page .discount-badge{position:absolute;top:15mm;right:15mm;width:40mm;height:40mm;background-color:var(--accent-color);color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:28pt;font-weight:900;z-index:3;box-shadow:0 4px 10px rgba(0,0,0,.2)}.a4-page .footer{display:flex;justify-content:space-between;align-items:flex-end;height:40mm;border-top:2px solid #eee;padding-top:8mm;z-index:2}.a4-page .qr-placeholder{width:30mm;height:30mm;border:2px solid #ccc;display:flex;justify-content:center;align-items:center;font-size:8pt;color:#aaa;text-align:center}.a4-page .promo-details{text-align:right;font-size:9pt;color:#555}@media print{body{padding:0;margin:0}.app-container,#print-btn{display:none}#a4-preview-container{margin:0;padding:0}.a4-page{transform:scale(1);margin:0;padding:0;box-shadow:none;width:100%;height:100%;page-break-after:always}.a4-page .content-wrapper{padding:15mm}}
    </style>
</head>
<body>

    <div class="app-container">
        <h1>A4 Promotion Generator (Cloud)</h1>
        
        <div class="form-group">
            <label for="item-code">1. Enter Item Code</label>
            <input type="text" id="item-code" placeholder="e.g., SKU-001 (Case-insensitive)">
            <div id="item-name-display">Fetching name...</div>
        </div>

        <div class="form-group">
            <label>2. Enter Pricing (in your currency)</label>
            <div class="price-container">
                <input type="number" id="price-before" placeholder="Price Before">
                <input type="number" id="price-after" placeholder="Price After">
            </div>
        </div>

        <button id="generate-btn">Generate A4 Design</button>
    </div>

    <div id="a4-preview-container" class="hidden">
        <div class="a4-page">
            <div id="a4-content"></div> 
        </div>
        <button id="print-btn">Print / Save as PDF</button>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC ---

        // 1. GET REFERENCES to all the HTML elements
        const itemCodeInput = document.getElementById('item-code');
        const itemNameDisplay = document.getElementById('item-name-display');
        const priceBeforeInput = document.getElementById('price-before');
        const priceAfterInput = document.getElementById('price-after');
        const generateBtn = document.getElementById('generate-btn');
        const printBtn = document.getElementById('print-btn');
        const a4PreviewContainer = document.getElementById('a4-preview-container');
        const a4Content = document.getElementById('a4-content');

        // 2. PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbwCf-tXajHN8pd-A1Kbe-3zHyN7bZqCBJL9sLgaI_n5ubvw5XBtIB3wl_aYMW0w910wkQ/exec'; 

        // 3. EVENT LISTENERS
        
        // Use a debounce function to avoid spamming the API on every keystroke
        let debounceTimer;
        itemCodeInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            const code = itemCodeInput.value.trim();
            if (code) {
                // Show a loading state
                itemNameDisplay.textContent = 'Fetching name...';
                itemNameDisplay.classList.remove('error');
                itemNameDisplay.style.color = 'var(--text-muted)';
                
                debounceTimer = setTimeout(() => {
                    fetchItemName(code);
                }, 500); // Wait 500ms after user stops typing
            } else {
                resetItemNameDisplay();
            }
        });

        // The async function to fetch data from our Google Apps Script API
        async function fetchItemName(code) {
            console.log(`[DEBUG] Fetching name for code: ${code}`);
            
            // Check if the URL has been set
            if (webAppUrl === 'YOUR_WEB_APP_URL_HERE') {
                console.error("[ERROR] Web App URL is not set. Please paste your deployment URL into the script.");
                itemNameDisplay.textContent = "ERROR: Web App URL is not configured.";
                itemNameDisplay.classList.add('error');
                return;
            }

            try {
                // Append the code as a query parameter to the URL
                const response = await fetch(`${webAppUrl}?code=${code}`);
                
                if (!response.ok) {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("[DEBUG] Received data from API:", data);

                if (data.status === 'success') {
                    itemNameDisplay.textContent = data.name;
                    itemNameDisplay.style.color = 'var(--text-color)';
                    itemNameDisplay.classList.remove('error');
                } else {
                    itemNameDisplay.textContent = data.message; // Show error from API
                    itemNameDisplay.classList.add('error');
                }

            } catch (error) {
                console.error('[ERROR] Failed to fetch item name:', error);
                itemNameDisplay.textContent = "Failed to connect to the database. Check console.";
                itemNameDisplay.classList.add('error');
            }
        }

        function resetItemNameDisplay() {
            itemNameDisplay.textContent = 'Product name will appear here...';
            itemNameDisplay.style.color = 'var(--text-muted)';
            itemNameDisplay.classList.remove('error');
        }

        generateBtn.addEventListener('click', () => {
            const itemName = itemNameDisplay.textContent;
            const priceBefore = parseFloat(priceBeforeInput.value);
            const priceAfter = parseFloat(priceAfterInput.value);

            // Updated validation to check for error states
            if (itemNameDisplay.classList.contains('error') || itemName.includes('...')) {
                alert('Please enter a valid Item Code first.');
                return;
            }
            if (!priceBefore || !priceAfter) {
                alert('Please enter both "Price Before" and "Price After".');
                return;
            }
            if (priceAfter >= priceBefore) {
                alert('The "Price After" discount must be lower than the "Price Before".');
                return;
            }

            const discountPercent = Math.round(((priceBefore - priceAfter) / priceBefore) * 100);
            
            a4Content.innerHTML = `
                <div class="content-wrapper">
                    <div class="discount-badge">${discountPercent}%</div>
                    <div class="promo-header">SALE</div>
                    <div class="main-content">
                        <div class="item-name">${itemName}</div>
                        <div class="price-display">
                            <div class="old-price">$${priceBefore.toFixed(2)}</div>
                            <div class="new-price">$${priceAfter.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="footer">
                        <div class="qr-placeholder">SCAN FOR<br>MORE INFO</div>
                        <div class="promo-details">
                            Promotion valid while stocks last.<br>
                            Offer subject to change without notice.
                        </div>
                    </div>
                </div>
            `;
            
            a4PreviewContainer.classList.remove('hidden');
            a4PreviewContainer.scrollIntoView({ behavior: 'smooth' });
        });

        printBtn.addEventListener('click', () => {
            window.print();
        });

        // Reset the display on page load
        resetItemNameDisplay();
    </script>
</body>
</html>
