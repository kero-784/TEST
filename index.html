<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pricing & Inquiry App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Enhanced CSS Styles with Animations (Pricing App) --- */
        :root {
            --primary-color: #007bff; --primary-color-darker: #0056b3; --secondary-color: #6c757d;
            --background-color: #f8f9fa; --card-background: #ffffff; --card-header-background: #e9ecef;
            --text-color-dark: #343a40; --text-color-light: #ffffff; --accent-color: #28a745;
            --danger-color: #dc3545; --danger-color-darker: #c82333;
        }
        body {
            font-family: 'Arial', sans-serif; padding: 15px; overflow-x: auto; display: flex; justify-content: center;
            align-items: flex-start; min-height: 100vh; background-color: var(--background-color);
            color: var(--text-color-dark);
        }
        body.popup-open {
            overflow: hidden;
        }
        #app-container {
            width: 95%; max-width: 700px; margin: 20px auto; background-color: var(--card-background); padding: 25px;
            border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); position: relative;
        }
        .top-actions {
            position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 10;
        }
        .top-actions button {
            padding: 8px 12px; border: none; color: var(--text-color-light); border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .top-actions button:hover { opacity: 0.8; transform: scale(1.05); }
        .card {
            border: none; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: var(--card-header-background); color: var(--text-color-dark); font-weight: bold;
            padding: 12px 20px; border-bottom: 1px solid #ddd; border-radius: 10px 10px 0 0;
        }
        .card-body { padding: 20px; }
        .form-group {
            margin-bottom: 1rem; display: flex; align-items: center; flex-wrap: wrap;
        }
        .form-group label {
            font-weight: 500; margin-bottom: 0; margin-right: 10px; color: var(--text-color-dark);
            text-align: left; flex-shrink: 0; width: auto; white-space: nowrap;
        }
        .form-control {
            border: 1px solid #ced4da; border-radius: 8px; padding: 0.6rem 0.7rem; box-shadow: none !important;
            transition: border-color 0.3s ease; vertical-align: middle; text-align: right; flex-grow: 1; min-width: 0;
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important; }
        .error-message { color: red; font-size: 0.8em; width: 100%; text-align: right; padding-top: 2px; }
        .adjustable-width.code-input { width: 120px; } .adjustable-width.type-select { width: 100px; }
        .adjustable-width.price-input { width: 100px; } .adjustable-width.unit-input { width: 80px; }
        .adjustable-width.discount-input, .adjustable-width.vat-select { width: 90px; }
        .inline-form { display: flex; align-items: center; gap: 8px; }
        .inline-form .form-control { margin-bottom: 0; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--text-color-light); }
        .btn-primary:hover, .btn-primary:focus, .btn-primary:active { background-color: var(--primary-color-darker) !important; border-color: var(--primary-color-darker) !important; }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); color: var(--text-color-light); }
        .btn-danger:hover, .btn-danger:focus, .btn-danger:active { background-color: var(--danger-color-darker) !important; border-color: var(--danger-color-darker) !important; }
        .btn {
            border-radius: 8px; padding: 0.6rem 1rem; transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); margin-right: 5px;
        }
        .btn:last-child { margin-right: 0; }
        .btn:hover, .btn:focus, .btn:active { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transform: scale(1.02); }
        .btn-success { background-color: var(--accent-color); border-color: var(--accent-color); color: var(--text-color-light); }
        .btn-success:hover { background-color: #1e7e34; border-color: #1e7e34; }
        .table-responsive { border: 1px solid #ddd; border-radius: 8px; overflow: auto; }
        #entriesTable { margin-bottom: 0; border-collapse: collapse; width: 100%; }
        #entriesTable thead th {
            background-color: var(--card-header-background); color: var(--text-color-dark); font-weight: bold;
            padding: 8px 12px; border-bottom: 2px solid #ddd; text-align: left;
        }
        #entriesTable tbody tr:nth-child(even) { background-color: #f9f9f9; }
        #entriesTable tbody tr:hover { background-color: #f2f2f2; transition: background-color 0.2s ease; }
        #entriesTable td { padding: 6px 10px; border-bottom: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        #entriesTable tbody tr:last-child td { border-bottom: none; }
        #message-container {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 123, 255, 0.9);
            color: var(--text-color-light); padding: 10px 15px; border-radius: 8px; z-index: 1100; opacity: 0; transition: opacity 0.4s ease, top 0.4s ease; top: -50px;
        }
        #message-container.show { opacity: 1; top: 20px; } #message-container.error { background-color: rgba(220, 53, 69, 0.9); }
        #loading-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
        }
        .spinner-border { width: 3rem; height: 3rem; }
        .popup-base {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            background-color: var(--card-background); padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 1050; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; width: 90%;
        }
        .popup-base.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        #databasePopup { max-width: 600px; }
        #databasePopup h3 { margin-top: 0; margin-bottom: 12px; color: var(--text-color-dark); }
        #databasePopup #databaseTableContainer { max-height: 400px; overflow-y: auto; }
        #databasePopup #databaseTable { width: 100%; border-collapse: collapse; }
        #databasePopup #databaseTable th, #databasePopup #databaseTable td { padding: 6px 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
        #databasePopup #databaseTable th { background-color: var(--card-header-background); font-weight: bold; position: sticky; top: 0; z-index: 1; }
        #databasePopup #databaseTable tbody tr:last-child td { border-bottom: none; }
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1040;
        }
        #overlay.show { display: block; }
        .actions-button-container { margin-top: 1rem; display: flex; gap: 10px; flex-wrap: wrap; }
        #inquiryPopup {
            max-width: 950px; direction: rtl; font-family: 'Cairo', sans-serif; background-color: #f4f7f9;
            color: #212529; max-height: 90vh; display: flex; flex-direction: column;
        }
        #inquiryPopup .popup-header-controls {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            padding-bottom: 15px; border-bottom: 1px solid #dee2e6;
        }
        #inquiryPopup .popup-content-area { overflow-y: auto; padding-right: 15px; }
        #inquiryPopup .app-container {
            background-color: #fff; padding: 20px 30px; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%;
        }
        #inquiryPopup .app-header { text-align: center; margin-bottom: 25px; color: #212529; border-bottom: 1px solid #dee2e6; padding-bottom: 15px; font-size: 1.6rem; font-weight: 600; }
        #inquiryPopup .form-group { margin-bottom: 20px; display: block; flex-wrap: nowrap; align-items: initial; }
        #inquiryPopup label { display: block; margin-bottom: 10px; font-weight: 500; color: #495057; text-align: right; }
        #inquiryPopup input[type="text"], #inquiryPopup select {
            width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: 0.3rem; font-size: 1rem; font-family: 'Cairo', sans-serif;
            background-color: #fdfdff; transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out; text-align: right;
        }
        #inquiryPopup input[type="text"]:focus, #inquiryPopup select:focus { border-color: #0077cc; box-shadow: 0 0 0 .2rem rgba(0,119,204,.25); outline: 0; }
        #inquiryPopup .search-action-group { display: flex; align-items: flex-end; gap: 15px; margin-bottom: 30px; }
        #inquiryPopup .search-action-group .form-group { flex-grow: 1; margin-bottom: 0; }
        #inquiryPopup .btn-primary {
            background-color: #0077cc; color: white; padding: 12px 20px; border: none; border-radius: 0.3rem; cursor: pointer;
            font-size: 1rem; font-family: 'Cairo', sans-serif; font-weight: 500; transition: all .15s ease-in-out;
            display: inline-flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        #inquiryPopup .btn-primary:hover { background-color: #005ea3; box-shadow: 0 .125rem .25rem rgba(0,0,0,.075); }
        #inquiryPopup .btn-primary:disabled { background-color: #adb5bd; color: #6c757d; cursor: not-allowed; box-shadow: none; opacity: 0.65; }
        #inquiryPopup .btn-primary .icon { width: 1em; height: 1em; }
        #inquiryPopup #resultsContainer { display: flex; flex-direction: column; gap: 30px; margin-top: 30px; }
        #inquiryPopup .result-card {
            background-color: #ffffff; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.05);
            transition: box-shadow 0.25s ease-in-out, border-right-color 0.25s ease-in-out; overflow: hidden; border-right: 5px solid #0077cc; border-left: none;
        }
        #inquiryPopup .result-card:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.1), 0 2px 6px rgba(0,0,0,0.07); }
        #inquiryPopup .result-card .card-header { padding: 18px 25px; background-color: #f9fbfd; border-bottom: 1px solid #e9ecef; }
        #inquiryPopup .result-card h2 { font-size: 1.2rem; font-weight: 600; color: #0077cc; margin: 0; display: flex; align-items: center; gap: 10px; transition: color 0.25s ease-in-out; }
        #inquiryPopup .title-icon { width: 1.2em; height: 1.2em; fill: currentColor; flex-shrink: 0; }
        #inquiryPopup .card-body { padding: 15px 25px 20px 25px; }
        #inquiryPopup .card-field { display: grid; grid-template-columns: minmax(140px, auto) 1fr; gap: 6px 12px; align-items: start; padding: 10px 0; border-bottom: 1px dashed #e9ecef; }
        #inquiryPopup .card-field:last-child { border-bottom: none; padding-bottom: 0; }
        #inquiryPopup .card-field:first-child { padding-top: 5px; }
        #inquiryPopup .field-label { font-weight: 500; color: #454f5b; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; line-height: 1.5; }
        #inquiryPopup .field-icon { width: 1.1em; height: 1.1em; fill: #6c757d; flex-shrink: 0; }
        #inquiryPopup .field-value { font-weight: 400; color: #2a2f36; word-break: break-word; line-height: 1.6; font-size: 0.95rem; text-align: right; }
        #inquiryPopup .card-field.exception-field .field-value { white-space: pre-wrap; background-color: #fdfdfd; padding: 8px 10px; border-radius: 0.3rem; border: 1px solid #f0f0f0; font-size: 0.9rem; max-height: 200px; overflow-y: auto; }
        #inquiryPopup .result-card.expired-exception { border-right-color: #dc3545; background-color: #fff8f8; }
        #inquiryPopup .result-card.expired-exception .card-header h2 { color: #dc3545; }
        #inquiryPopup .card-body .expiry-warning { padding: 10px 15px; margin-bottom: 15px; border-radius: 0.3rem; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; font-weight: 500; text-align: center; }
        #inquiryPopup .message-area { padding: 15px 20px; margin-top: 20px; border-radius: 0.3rem; text-align: center; border: 1px solid transparent; font-size: 0.95rem; }
        #inquiryPopup .message-area.info { background-color: #e0f3ff; color: #004085; border-color: #b8daff;}
        #inquiryPopup .message-area.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}
        #inquiryPopup .message-area.no-results { background-color: #fff3cd; color: #856404; border-color: #ffeeba;}
        #inquiryPopup .loader-container { text-align: center; padding: 20px 0; height: 60px; }
        #inquiryPopup .loader { border: 5px solid #f3f3f3; border-top: 5px solid #0077cc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Loading Indicator -->
        <div id="loading-indicator">
            <div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>
            <p>Loading database...</p>
        </div>
        <!-- Top Right Action Buttons -->
        <div class="top-actions">
            <button class="btn btn-info btn-sm" onclick="openInquiryPopup()" title="Inquire Exceptions"><i class="fas fa-search-dollar"></i></button>
            <button class="btn btn-secondary btn-sm" onclick="viewDatabase()" title="View Database"><i class="fas fa-database"></i></button>
            <button class="btn btn-danger btn-sm" onclick="clearDatabase()" title="Clear Local Database"><i class="fas fa-trash"></i></button>
        </div>
        <!-- Message Container -->
        <div id="message-container"></div>
        <!-- Data Retrieval & Calculation Section -->
        <div class="card mb-3">
            <div class="card-header">Item Details & Calculation</div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="code">Code:</label>
                        <input type="text" class="form-control adjustable-width code-input" id="code" oninput="getItemDetails()">
                        <div id="codeError" class="error-message"></div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="type">Type:</label>
                        <select class="form-control adjustable-width type-select" id="type"
                            onchange="toggleCurrentPriceField()">
                            <option value="شراء">شراء</option>
                            <option value="مرتجع">مرتجع</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="currentPriceDiv" style="display:none;">
                    <label for="currentPrice">Current Price:</label>
                    <input type="number" step="0.001" class="form-control adjustable-width price-input" id="currentPrice"
                        oninput="calculateTotal()">
                    <div id="currentPriceError" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" class="form-control" id="name" readonly>
                </div>
                <div class="form-group">
                    <label for="supplierName">Supplier Name:</label>
                    <input type="text" class="form-control" id="supplierName" readonly>
                </div>
                <div class="form-group">
                    <label for="alternateSupplierCheck">شراء من مورد اخر:</label>
                    <div class="form-check" style="padding-top: 8px; padding-bottom: 8px;">
                        <input type="checkbox" class="form-check-input" id="alternateSupplierCheck"
                            onchange="toggleAlternateSupplier()" style="margin-left: 0;">
                        <label class="form-check-label" for="alternateSupplierCheck" style="margin-left: 20px; margin-bottom: 0;"> </label>
                    </div>
                </div>
                <div class="form-group" id="alternateSupplierDiv" style="display: none;">
                    <label for="alternateSupplierName">Alternate Supplier Name:</label>
                    <input type="text" class="form-control" id="alternateSupplierName">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="cost">Case Cost:</label>
                        <input type="number" step="0.001" class="form-control adjustable-width unit-input" id="cost" required
                            oninput="calculateTotal()">
                        <div id="costError" class="error-message"></div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="unit">Units per Case:</label>
                        <input type="number" class="form-control adjustable-width unit-input" id="unit" value="1"
                            oninput="calculateTotal()">
                        <div id="unitError" class="error-message"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="discount">Discount (%):</label>
                        <input type="number" class="form-control adjustable-width discount-input" id="discount" value="0"
                            oninput="calculateTotal()">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="vat">VAT (%):</label>
                        <select class="form-control adjustable-width vat-select" id="vat" onchange="calculateTotal()">
                            <option value="0" selected>0</option>
                            <option value="5">5</option>
                            <option value="14">14</option>
                        </select>
                        <div id="vatError" class="error-message"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="unitPrice">Unit Price (After Discount & VAT):</label>
                    <input type="text" class="form-control adjustable-width price-input" id="unitPrice" readonly>
                </div>
                <div class="form-group">
                    <label for="casePrice">Case Price (After Discount & VAT):</label>
                    <input type="text" class="form-control adjustable-width price-input" id="casePrice" readonly>
                </div>
                <button class="btn btn-primary" onclick="addToList()"><i class="fas fa-save"></i> Save to Local</button>
            </div>
        </div>
        <!-- Data Management Section -->
        <div class="card mb-3">
            <div class="card-header">Entries</div>
            <div class="card-body table-container">
                <div class="table-responsive">
                    <table id="entriesTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Code</th><th>Name</th><th>Supplier</th><th>Units</th><th>Discount</th>
                                <th>VAT</th><th>Piece</th><th>Case</th><th>Type</th><th>Current</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Export and Clear Section -->
        <div class="actions-button-container">
             <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button>
             <button class="btn btn-info" onclick="exportToJPG()"><i class="fas fa-file-image"></i> Export to JPG</button>
             <button class="btn btn-danger" onclick="clearAll()"><i class="fas fa-broom"></i> Clear All Entries</button>
        </div>

        <!-- ======================= POPUPS =========================== -->
        <!-- Popup for Database View -->
        <div id="databasePopup" class="popup-base">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>Database</h3>
                <button onclick="closeAllPopups()" class="btn btn-secondary btn-sm"><i class="fas fa-times"></i> Close</button>
            </div>
            <div id="databaseTableContainer">
                <table id="databaseTable">
                    <thead><tr><th>Code</th><th>Name</th><th>Supplier Name</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Popup for Inquiry App -->
        <div id="inquiryPopup" class="popup-base">
            <div class="popup-header-controls">
                <button onclick="closeAllPopups()" class="btn btn-danger btn-sm" style="margin-left: auto;"><i class="fas fa-times"></i> إغلاق</button>
            </div>
            <div class="popup-content-area">
                <div class="app-container">
                    <h1 class="app-header">الاستعلام عن الاستثناءات</h1>
                    <div class="form-group">
                        <label for="searchType">نوع البحث:</label>
                        <select id="searchType">
                            <option value="GeneratedCode">بحث بكود الاستثناء</option>
                            <option value="SupplierCode">بحث بكود المورد</option>
                        </select>
                    </div>
                    <div class="search-action-group">
                        <div class="form-group" style="flex-grow: 1;">
                            <label for="searchTerm">قيمة البحث:</label>
                            <input type="text" id="searchTerm" placeholder="ادخل كود الاستثناء أو كود المورد">
                        </div>
                        <button id="searchBtn" class="btn-primary" type="button">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="icon">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                            <span>بحث</span>
                        </button>
                    </div>
                    <div class="loader-container"><div class="loader" id="loader"></div></div>
                    <div id="queryMessage" class="message-area" style="display:none;"></div>
                    <div id="resultsContainer" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Overlay for all popups -->
        <div id="overlay"></div>

        <canvas id="hiddenCanvas" style="display:none;"></canvas>
    </div>

    <!-- SCRIPT SECTION -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        /*************************************************/
        /* SCRIPT FOR PRICING APP (CORE LOGIC)           */
        /*************************************************/
        const firebaseConfig = {
            apiKey: "AIzaSyAqB5syqP1BVfA9dUx3A6zvokDw3oacy_E", authDomain: "data-base-2c8bf.firebaseapp.com",
            projectId: "data-base-2c8bf", storageBucket: "data-base-2c8bf.firebasestorage.app",
            messagingSenderId: "958395018379", appId: "1:958395018379:web:eb7588afda28e32e5a788e", measurementId: "G-PMJ02H7PK2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let database = [];
        let entries = [];
        const googleSheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrRFFRPe_jrOrDZM58gRqxfsA0deD60_q2jkA7XJRRfJQ7IiBdIqNDN7JdMawjw/pub?output=csv";
        const LOCAL_STORAGE_ENTRIES_KEY = 'pricingAppEntries';

        function saveEntriesToLocalStorage() { localStorage.setItem(LOCAL_STORAGE_ENTRIES_KEY, JSON.stringify(entries)); }
        function loadEntriesFromLocalStorage() { const storedEntries = localStorage.getItem(LOCAL_STORAGE_ENTRIES_KEY); return storedEntries ? JSON.parse(storedEntries) : []; }
        function clearEntriesFromLocalStorage() { localStorage.removeItem(LOCAL_STORAGE_ENTRIES_KEY); }
        function showLoadingIndicator() { document.getElementById('loading-indicator').style.display = 'flex'; }
        function hideLoadingIndicator() { document.getElementById('loading-indicator').style.display = 'none'; }

        function displayMessage(message, isError = false) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.textContent = message;
            messageContainer.className = isError ? 'error show' : 'show';
            setTimeout(() => { messageContainer.classList.remove('show'); }, 3000);
        }

        function displayError(elementId, message) { const el = document.getElementById(elementId); if (el) el.textContent = message; }
        function clearError(elementId) { const el = document.getElementById(elementId); if (el) el.textContent = ''; }

        function autoLoadDatabase() {
            showLoadingIndicator();
            fetch(googleSheetCsvUrl)
                .then(response => { if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return response.text(); })
                .then(csvData => {
                    const newDatabase = parseCSV(csvData);
                    if (newDatabase.length > 0 && (!newDatabase[0].code || !newDatabase[0].name || !newDatabase[0]['supplier name'])) {
                        displayMessage('Google Sheet must have columns: code, name, and supplier name.', true); return;
                    }
                    database = newDatabase;
                    displayMessage('Database auto-loaded successfully from Google Sheet!');
                })
                .catch(error => { console.error('Error auto-loading database:', error); displayMessage(`Error auto-loading: ${error.message}.`, true); })
                .finally(() => { hideLoadingIndicator(); });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\r$/, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/\r$/, ''));
                if (values.length === headers.length) {
                    const rowData = {};
                    for (let j = 0; j < headers.length; j++) { rowData[headers[j]] = values[j]; }
                    data.push(rowData);
                }
            }
            return data;
        }

        window.onload = function () {
            loadEntriesFromLocalStorageAndUpdateTable();
            autoLoadDatabase();
            toggleCurrentPriceField();
        };

        function loadEntriesFromLocalStorageAndUpdateTable() { entries = loadEntriesFromLocalStorage(); updateEntriesTable(); }

        async function clearDatabase() {
            if (confirm("Are you sure you want to clear the locally loaded database?")) {
                database = []; displayMessage('In-memory database cleared!');
                const popupTableBody = document.querySelector('#databasePopup #databaseTable tbody');
                if (popupTableBody) {
                     popupTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Database is empty.</td></tr>';
                }
            }
        }

        function getItemDetails() {
            const code = document.getElementById('code').value.trim(); clearError('codeError');
            document.getElementById('name').value = ''; document.getElementById('supplierName').value = '';
            if (!code) return;
            const foundItem = database.find(item => item.code === code);
            if (foundItem) {
                document.getElementById('name').value = foundItem.name || '';
                document.getElementById('supplierName').value = foundItem['supplier name'] || '';
            } else { displayMessage('Item details not found.', true); }
        }

        function toggleAlternateSupplier() { document.getElementById('alternateSupplierDiv').style.display = document.getElementById('alternateSupplierCheck').checked ? 'flex' : 'none'; }
        function toggleCurrentPriceField() { document.getElementById('currentPriceDiv').style.display = document.getElementById('type').value === 'مرتجع' ? 'flex' : 'none'; }

        function calculateTotal() {
            clearError('costError'); clearError('unitError');
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const unit = parseInt(document.getElementById('unit').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const vatRate = parseFloat(document.getElementById('vat').value) || 0;
            if (cost < 0) { displayError('costError', 'Cost must be non-negative.'); return; }
            if (unit <= 0) { displayError('unitError', 'Units must be positive.'); return; }
            let discountedCost = cost * (1 - discount / 100);
            let costWithVat = discountedCost * (1 + vatRate / 100);
            let unitPriceValue = (unit > 0) ? (costWithVat / unit) : 0;
            document.getElementById('unitPrice').value = unitPriceValue.toFixed(3);
            document.getElementById('casePrice').value = costWithVat.toFixed(3);
        }

        function addToList() {
            let isValid = true;
            clearError('codeError'); clearError('costError'); clearError('unitError'); clearError('currentPriceError');
            const code = document.getElementById('code').value.trim();
            if (!code) { displayError('codeError', 'Code is required.'); isValid = false; }
            const costInput = document.getElementById('cost').value;
            if (costInput === '' || isNaN(parseFloat(costInput)) || parseFloat(costInput) < 0) { displayError('costError', 'Valid case cost is required.'); isValid = false; }
            const unit = parseInt(document.getElementById('unit').value);
            if (isNaN(unit) || unit <= 0) { displayError('unitError', 'Valid units (> 0) required.'); isValid = false; }
            const type = document.getElementById('type').value;
            const currentPriceInput = document.getElementById('currentPrice').value;
            let currentFormatted = '';
            if (type === 'مرتجع') {
                if (currentPriceInput === '' || isNaN(parseFloat(currentPriceInput)) || parseFloat(currentPriceInput) < 0) {
                    displayError('currentPriceError', 'Valid current price required.'); isValid = false;
                } else { currentFormatted = parseFloat(currentPriceInput).toFixed(3); }
            }
            if (!isValid) { displayMessage('Please correct errors before saving.', true); return; }
            const alternateSupplierCheck = document.getElementById('alternateSupplierCheck').checked;
            const alternateSupplierName = document.getElementById('alternateSupplierName').value.trim();
            const discount = parseFloat(document.getElementById('discount').value);
            entries.push({
                code: code, name: document.getElementById('name').value.trim(),
                supplier: alternateSupplierCheck && alternateSupplierName ? alternateSupplierName : document.getElementById('supplierName').value.trim(),
                units: unit, discount: isNaN(discount) ? 0 : discount, vat: document.getElementById('vat').value,
                piece: document.getElementById('unitPrice').value, case: document.getElementById('casePrice').value,
                type: type, current: currentFormatted
            });
            saveEntriesToLocalStorage(); updateEntriesTable(); displayMessage('Item added to list.'); clearInputFields();
        }

        function clearInputFields() {
            document.getElementById('code').value = ''; document.getElementById('name').value = '';
            document.getElementById('supplierName').value = ''; document.getElementById('alternateSupplierCheck').checked = false;
            document.getElementById('alternateSupplierName').value = ''; document.getElementById('alternateSupplierDiv').style.display = 'none';
            document.getElementById('cost').value = ''; document.getElementById('unit').value = '1';
            document.getElementById('discount').value = '0'; document.getElementById('vat').value = '0';
            document.getElementById('unitPrice').value = ''; document.getElementById('casePrice').value = '';
            document.getElementById('currentPrice').value = ''; document.getElementById('type').value = 'شراء';
            toggleCurrentPriceField(); clearError('codeError'); clearError('costError'); clearError('unitError'); clearError('currentPriceError');
        }

        function updateEntriesTable() {
            const tableBody = document.querySelector('#entriesTable tbody');
            tableBody.innerHTML = '';
            entries.forEach((entry, index) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = entry.code; row.insertCell().textContent = entry.name;
                row.insertCell().textContent = entry.supplier; row.insertCell().textContent = entry.units;
                row.insertCell().textContent = entry.discount; row.insertCell().textContent = entry.vat;
                row.insertCell().textContent = entry.piece; row.insertCell().textContent = entry.case;
                row.insertCell().textContent = entry.type; row.insertCell().textContent = entry.current;
                const actionsCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm'; deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = () => deleteLocalEntry(index);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function deleteLocalEntry(index) { if (confirm("Delete this entry?")) { entries.splice(index, 1); saveEntriesToLocalStorage(); updateEntriesTable(); displayMessage('Entry deleted.'); } }
        async function clearAll() { if (confirm("Clear all entries?")) { clearEntriesFromLocalStorage(); entries = []; updateEntriesTable(); displayMessage('All entries cleared.'); } }

        function exportToExcel() {
            if (entries.length === 0) { displayMessage('No entries to export.', true); return; }
            const dataForExcel = entries.map(e => ({ "Code": e.code, "Name": e.name, "Supplier": e.supplier, "Units": e.units, "Discount (%)": e.discount, "VAT (%)": e.vat, "Piece Price": e.piece, "Case Price": e.case, "Type": e.type, "Current Price": e.current }));
            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Entries");
            XLSX.writeFile(wb, "pricing_entries.xlsx");
            displayMessage('Exported to Excel!');
        }

        function exportToJPG() {
            const table = document.getElementById('entriesTable');
            if (entries.length === 0) { displayMessage('No entries to export.', true); return; }
            html2canvas(table, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.download = 'entries_table.jpg'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                displayMessage('Exported to JPG!');
            }).catch(error => { console.error('JPG Export Error:', error); displayMessage('Error exporting to JPG.', true); });
        }

        /*************************************************/
        /* ROBUST POPUP CONTROL SYSTEM (UPDATED)         */
        /*************************************************/
        let currentSearchController; // For AbortController

        function openPopup(popupId) {
            const popup = document.getElementById(popupId);
            const overlay = document.getElementById('overlay');
            if (!popup || !overlay) return;
            popup.classList.add('show');
            overlay.classList.add('show');
            document.body.classList.add('popup-open');
            overlay.addEventListener('click', closeAllPopups);
            document.addEventListener('keydown', handleEscKey);
        }

        function closeAllPopups() {
            const openPopups = document.querySelectorAll('.popup-base.show');
            const overlay = document.getElementById('overlay');

            // Abort any ongoing fetch request before closing
            if (currentSearchController) {
                currentSearchController.abort();
                console.log("Search aborted due to popup closure.");
            }

            openPopups.forEach(p => p.classList.remove('show'));
            if (overlay) {
                overlay.classList.remove('show');
                overlay.removeEventListener('click', closeAllPopups);
            }
            
            document.body.classList.remove('popup-open');
            document.removeEventListener('keydown', handleEscKey);

            // --- Specific cleanup for the Inquiry Popup ---
            const inquirySearchBtn = document.getElementById('searchBtn');
            if (inquirySearchBtn) {
                inquirySearchBtn.disabled = false;
            }
            const inquiryLoader = document.getElementById('loader');
            if (inquiryLoader) {
                inquiryLoader.style.display = 'none';
            }
            const queryMessage = document.getElementById('queryMessage');
            if (queryMessage) {
                 queryMessage.style.display = 'none';
            }
            const resultsContainer = document.getElementById('resultsContainer');
            if(resultsContainer) {
                resultsContainer.style.display = 'none';
                resultsContainer.innerHTML = '';
            }
        }

        function handleEscKey(event) { if (event.key === 'Escape') { closeAllPopups(); } }

        function viewDatabase() {
            const tableBody = document.querySelector('#databasePopup #databaseTable tbody');
            tableBody.innerHTML = '';
            if (database.length === 0) { tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Database is empty or not loaded.</td></tr>';
            } else { database.forEach(item => { const row = tableBody.insertRow(); row.insertCell().textContent = item.code || ''; row.insertCell().textContent = item.name || ''; row.insertCell().textContent = item['supplier name'] || ''; }); }
            openPopup('databasePopup');
        }

        function openInquiryPopup() { openPopup('inquiryPopup'); }

        /*************************************************/
        /* SCRIPT FOR INQUIRY POPUP (UPDATED)            */
        /*************************************************/
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxBZi1K-z8ecjbukUcfsZWkPgBqSw0H2xDTpZBcaIdoKQS9Y0D2DJ54gbf0n6uvwmYXRw/exec';
        const URL_PLACEHOLDER_STRING = 'YOUR_GAS_URL_PLACEHOLDER_REPLACE_ME';
        const searchBtn = document.getElementById('searchBtn');
        const searchTypeSelect = document.getElementById('searchType');
        const searchTermInput = document.getElementById('searchTerm');
        const resultsContainer = document.getElementById('resultsContainer');
        const queryMessage = document.getElementById('queryMessage');
        const loader = document.getElementById('loader');

        const fieldIcons = { /* ... Icons object remains the same ... */ };
        let criticalConfigErrorInquiry = false;
        if (GAS_WEB_APP_URL === URL_PLACEHOLDER_STRING || !GAS_WEB_APP_URL) { criticalConfigErrorInquiry = true; if(searchBtn) searchBtn.disabled = true; }
        function showMessageInquiry(message, type = 'info') { queryMessage.textContent = message; queryMessage.className = `message-area ${type}`; queryMessage.style.display = 'block'; }
        function hideMessageInquiry() { queryMessage.style.display = 'none'; }

        function displayResults(data) {
            resultsContainer.innerHTML = ''; resultsContainer.style.display = 'none'; hideMessageInquiry();
            if (!data || data.length === 0) { showMessageInquiry('لم يتم العثور على نتائج تطابق بحثك.', 'no-results'); return; }
            const fieldOrderAndLabels = { "GeneratedCode": "كود الاستثناء", "Timestamp": "وقت التسجيل", "PurchasingOfficer": "مسؤول المشتريات", "EntryDate": "تاريخ الإدخال", "Period Start Date": "تاريخ بداية الفترة", "Period End Date": "تاريخ نهاية الفترة", "SupplierName": "اسم المورد", "SupplierCode": "كود المورد", "Exception": "تفاصيل الاستثناء" };
            data.forEach((record, index) => {
                let expiryWarningHtml = ''; let cardExtraClass = ''; const endDateString = record["Period End Date"];
                if (endDateString) {
                    const endDate = new Date(endDateString); const today = new Date(); today.setHours(0, 0, 0, 0);
                    if (!isNaN(endDate.getTime()) && endDate < today) { expiryWarningHtml = `<div class="expiry-warning">تنبيه: فترة هذا الاستثناء قد انتهت.</div>`; cardExtraClass = 'expired-exception'; }
                }
                const card = document.createElement('div'); card.className = `result-card ${cardExtraClass}`;
                const cardTitleText = record.GeneratedCode ? `بيانات الاستثناء (الكود: ${record.GeneratedCode})` : `بيانات الاستثناء #${index + 1}`;
                let cardFieldsHtml = '';
                for (const key in fieldOrderAndLabels) {
                    if (Object.hasOwnProperty.call(fieldOrderAndLabels, key)) {
                        const label = fieldOrderAndLabels[key]; let value = record[key]; const iconSvg = fieldIcons[key] || fieldIcons.default;
                        const fieldClass = key === "Exception" ? "card-field exception-field" : "card-field";
                        const dateKeys = ["Timestamp", "EntryDate", "Period Start Date", "Period End Date"];
                        if (dateKeys.includes(key) && value) {
                            try { const dateObj = new Date(value); if (!isNaN(dateObj.getTime())) { const day = String(dateObj.getDate()).padStart(2, '0'); const month = String(dateObj.getMonth() + 1).padStart(2, '0'); const year = dateObj.getFullYear(); value = `${day}-${month}-${year}`; } } catch (e) { /* ignore */ }
                        }
                        value = (value === undefined || value === null || String(value).trim() === "") ? "غير متوفر" : value;
                        cardFieldsHtml += `<div class="${fieldClass}"><strong class="field-label">${iconSvg} <span>${label}:</span></strong><span class="field-value">${value}</span></div>`;
                    }
                }
                card.innerHTML = `<div class="card-header"><h2>${fieldIcons.title} ${cardTitleText}</h2></div><div class="card-body">${expiryWarningHtml}${cardFieldsHtml}</div>`;
                resultsContainer.appendChild(card);
            });
            resultsContainer.style.display = 'flex';
        }

        searchBtn.addEventListener('click', async () => {
            if (criticalConfigErrorInquiry) { showMessageInquiry('خطأ حرج: لم يتم تكوين رابط Google Apps Script.', 'error'); return; }
            const searchType = searchTypeSelect.value; const searchTerm = searchTermInput.value.trim();
            if (!searchTerm) { showMessageInquiry('الرجاء إدخال قيمة للبحث.', 'error'); searchTermInput.focus(); return; }
            
            // Set up AbortController for the fetch request
            currentSearchController = new AbortController();
            const signal = currentSearchController.signal;

            hideMessageInquiry(); resultsContainer.style.display = 'none'; resultsContainer.innerHTML = '';
            loader.style.display = 'block'; searchBtn.disabled = true;
            const params = new URLSearchParams({ action: 'inquireData', searchType: searchType, searchTerm: searchTerm });
            
            try {
                const response = await fetch(`${GAS_WEB_APP_URL}?${params.toString()}`, { 
                    method: 'GET', 
                    mode: 'cors',
                    signal: signal // Pass the signal to the fetch request
                });
                if (!response.ok) { throw new Error(`خطأ في الشبكة أو السيرفر: ${response.status} ${response.statusText}`); }
                const result = await response.json();
                if (result.success && result.data) { displayResults(result.data); } else { showMessageInquiry(result.error || result.message || 'حدث خطأ غير متوقع.', 'error'); }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // This error is expected if the user closes the popup, so we can ignore it or log it quietly.
                    console.log('Fetch aborted.');
                } else {
                    console.error('[Fetch API] CATCH BLOCK:', error);
                    showMessageInquiry(`فشل الاستعلام: ${error.message}`, 'error');
                }
            } finally {
                loader.style.display = 'none'; 
                searchBtn.disabled = false;
                currentSearchController = null; // Clear the controller after the operation is complete
            }
        });
    </script>
</body>
</html>
