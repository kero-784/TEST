<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pricing App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Enhanced CSS Styles with Animations --- */

        /* --- Color Palette --- */
        :root {
            --primary-color: #007bff;
            --primary-color-darker: #0056b3;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --card-header-background: #e9ecef;
            --text-color-dark: #343a40;
            --text-color-light: #ffffff;
            --accent-color: #28a745; /* Green for success/excel export */
            --danger-color: #dc3545;
            --danger-color-darker: #c82333;
        }

        body {
            font-family: 'Arial', sans-serif;
            padding: 15px;
            overflow-x: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: var(--background-color);
            color: var(--text-color-dark);
            overflow: auto !important;
        }

        #app-container {
            width: 95%;
            max-width: 700px;
            margin: 20px auto;
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* --- Top Actions Buttons --- */
        .top-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .top-actions button {
            padding: 8px 12px;
            border: none;
            background-color: var(--secondary-color);
            color: var(--text-color-light);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .top-actions button:hover {
            background-color: var(--secondary-color);
            opacity: 0.8;
            transform: scale(1.05);
        }

        /* --- Card Styling --- */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: var(--card-header-background);
            color: var(--text-color-dark);
            font-weight: bold;
            padding: 12px 20px;
            border-bottom: 1px solid #ddd;
            border-radius: 10px 10px 0 0;
        }

        .card-body {
            padding: 20px;
        }

        /* --- Form Styling --- */
        .form-group {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0;
            margin-right: 10px;
            color: var(--text-color-dark);
            text-align: left;
            flex-shrink: 0;
            width: auto;
            white-space: nowrap;
        }

        .form-control {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 0.6rem 0.7rem;
            box-shadow: none !important;
            transition: border-color 0.3s ease;
            vertical-align: middle;
            text-align: right;
            flex-grow: 1;
            min-width: 0;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        }
        .error-message {
            color: red;
            font-size: 0.8em;
            width: 100%;
            text-align: right;
            padding-top: 2px;
        }

        .adjustable-width.code-input { width: 120px; }
        .adjustable-width.type-select { width: 100px; }
        .adjustable-width.price-input { width: 100px; }
        .adjustable-width.unit-input { width: 80px; }
        .adjustable-width.discount-input,
        .adjustable-width.vat-select { width: 90px; }

        .inline-form { display: flex; align-items: center; gap: 8px; }
        .inline-form .form-control { margin-bottom: 0; }

        /* --- Buttons (General) --- */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--text-color-light);
        }
        .btn-primary:hover, .btn-primary:focus, .btn-primary:active {
            background-color: var(--primary-color-darker) !important;
            border-color: var(--primary-color-darker) !important;
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: var(--text-color-light);
        }
        .btn-danger:hover, .btn-danger:focus, .btn-danger:active {
            background-color: var(--danger-color-darker) !important;
            border-color: var(--danger-color-darker) !important;
        }


        .btn-secondary, .btn-info, .btn-success { /* Standard styling for these */
             /* Bootstrap default will apply or define specific colors if needed */
        }

        /* Common button styles for custom and Bootstrap */
        .btn { /* Ensure all buttons share these base styles */
            border-radius: 8px;
            padding: 0.6rem 1rem; /* Standardized padding */
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            margin-right: 5px; /* Add some space between buttons */
        }
        .btn:last-child {
            margin-right: 0; /* No margin for the last button in a group */
        }

        .btn:hover, .btn:focus, .btn:active {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: scale(1.02);
        }

         .btn-success {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--text-color-light);
        }
        .btn-success:hover {
            background-color: #1e7e34; /* Darker green */
            border-color: #1e7e34;
        }

        /* --- Entries Table Styling --- */
        .table-responsive { border: 1px solid #ddd; border-radius: 8px; overflow: auto; }
        #entriesTable { margin-bottom: 0; border-collapse: collapse; width: 100%; }
        #entriesTable thead th {
            background-color: var(--card-header-background);
            color: var(--text-color-dark);
            font-weight: bold;
            padding: 8px 12px;
            border-bottom: 2px solid #ddd;
            text-align: left;
        }
        #entriesTable tbody tr:nth-child(even) { background-color: #f9f9f9; }
        #entriesTable tbody tr:hover { background-color: #f2f2f2; transition: background-color 0.2s ease; }
        #entriesTable td {
            padding: 6px 10px;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        #entriesTable tbody tr:last-child td { border-bottom: none; }

        /* --- Message Container Animation --- */
        #message-container {
            display: none; position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 123, 255, 0.9);
            color: var(--text-color-light);
            padding: 10px 15px; border-radius: 8px; z-index: 1100;
            opacity: 0; transition: opacity 0.4s ease, top 0.4s ease; top: -50px;
        }
        #message-container.show { opacity: 1; top: 20px; }
        #message-container.error { background-color: rgba(220, 53, 69, 0.9); }

        /* --- Loading Indicator Styles --- */
        #loading-indicator {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .spinner-border { width: 3rem; height: 3rem; }

        /* --- Database Popup Styling and Animation --- */
        #databasePopup {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: var(--card-background);
            padding: 20px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 1050; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease;
            width: 90%; max-width: 600px;
        }
        #databasePopup.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        #databasePopup h3 { margin-top: 0; margin-bottom: 12px; color: var(--text-color-dark); }
        #databasePopup #databaseTableContainer { max-height: 400px; overflow-y: auto; }
        #databasePopup #databaseTable { width: 100%; border-collapse: collapse; }
        #databasePopup #databaseTable th, #databasePopup #databaseTable td {
            padding: 6px 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap;
        }
        #databasePopup #databaseTable th {
            background-color: var(--card-header-background); font-weight: bold;
            position: sticky; top: 0; z-index: 1;
        }
        #databasePopup #databaseTable tbody tr:last-child td { border-bottom: none; }

        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1040;
        }
        #overlay.show { display: block; }

        .actions-button-container { /* General container for action buttons */
            margin-top: 1rem;
            display: flex;
            gap: 10px; /* Space between buttons */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
    </style>
</head>

<body>

    <div id="app-container">
        <!-- Loading Indicator -->
        <div id="loading-indicator">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p>Loading database...</p>
        </div>

        <!-- Top Right Action Buttons -->
        <div class="top-actions">
            <button class="btn btn-secondary btn-sm" onclick="viewDatabase()" title="View Database"><i class="fas fa-database"></i></button>
            <button class="btn btn-danger btn-sm" onclick="clearDatabase()" title="Clear Local Database"><i class="fas fa-trash"></i></button>
        </div>

        <!-- Message Container -->
        <div id="message-container"></div>

        <!-- Data Retrieval & Calculation Section -->
        <div class="card mb-3">
            <div class="card-header">Item Details & Calculation</div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="code">Code:</label>
                        <input type="text" class="form-control adjustable-width code-input" id="code" oninput="getItemDetails()">
                        <div id="codeError" class="error-message"></div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="type">Type:</label>
                        <select class="form-control adjustable-width type-select" id="type"
                            onchange="toggleCurrentPriceField()">
                            <option value="شراء">شراء</option>
                            <option value="مرتجع">مرتجع</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="currentPriceDiv" style="display:none;">
                    <label for="currentPrice">Current Price:</label>
                    <input type="number" step="0.001" class="form-control adjustable-width price-input" id="currentPrice"
                        oninput="calculateTotal()">
                    <div id="currentPriceError" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" class="form-control" id="name" readonly>
                </div>
                <div class="form-group">
                    <label for="supplierName">Supplier Name:</label>
                    <input type="text" class="form-control" id="supplierName" readonly>
                </div>
                <div class="form-group">
                    <label for="alternateSupplierCheck">شراء من مورد اخر:</label>
                    <div class="form-check" style="padding-top: 8px; padding-bottom: 8px;">
                        <input type="checkbox" class="form-check-input" id="alternateSupplierCheck"
                            onchange="toggleAlternateSupplier()" style="margin-left: 0;">
                        <label class="form-check-label" for="alternateSupplierCheck" style="margin-left: 20px; margin-bottom: 0;"> </label>
                    </div>
                </div>
                <div class="form-group" id="alternateSupplierDiv" style="display: none;">
                    <label for="alternateSupplierName">Alternate Supplier Name:</label>
                    <input type="text" class="form-control" id="alternateSupplierName">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="cost">Case Cost:</label>
                        <input type="number" step="0.001" class="form-control adjustable-width unit-input" id="cost" required
                            oninput="calculateTotal()">
                        <div id="costError" class="error-message"></div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="unit">Units per Case:</label>
                        <input type="number" class="form-control adjustable-width unit-input" id="unit" value="1"
                            oninput="calculateTotal()">
                        <div id="unitError" class="error-message"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="discount">Discount (%):</label>
                        <input type="number" class="form-control adjustable-width discount-input" id="discount" value="0"
                            oninput="calculateTotal()">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="vat">VAT (%):</label>
                        <select class="form-control adjustable-width vat-select" id="vat" onchange="calculateTotal()">
                            <option value="0" selected>0</option>
                            <option value="5">5</option>
                            <option value="14">14</option>
                        </select>
                        <div id="vatError" class="error-message"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="unitPrice">Unit Price (After Discount & VAT):</label>
                    <input type="text" class="form-control adjustable-width price-input" id="unitPrice" readonly>
                </div>
                <div class="form-group">
                    <label for="casePrice">Case Price (After Discount & VAT):</label>
                    <input type="text" class="form-control adjustable-width price-input" id="casePrice" readonly>
                </div>
                <!-- MOVED Clear All Entries button from here -->
                <button class="btn btn-primary" onclick="addToList()"><i class="fas fa-save"></i> Save to Local</button>
            </div>
        </div>

        <!-- Data Management Section -->
        <div class="card mb-3">
            <div class="card-header">Entries</div>
            <div class="card-body table-container">
                <div class="table-responsive">
                    <table id="entriesTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Supplier</th>
                                <th>Units</th>
                                <th>Discount</th>
                                <th>VAT</th>
                                <th>Piece</th>
                                <th>Case</th>
                                <th>Type</th>
                                <th>Current</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Export and Clear Section -->
        <div class="actions-button-container"> <!-- Renamed from export-buttons-container -->
             <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button>
             <button class="btn btn-info" onclick="exportToJPG()"><i class="fas fa-file-image"></i> Export to JPG</button>
             <button class="btn btn-danger" onclick="clearAll()"><i class="fas fa-broom"></i> Clear All Entries</button> <!-- MOVED HERE -->
        </div>


        <!-- Popup for Database View -->
        <div id="databasePopup">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>Database</h3>
                <button onclick="closeDatabasePopup()" class="btn btn-secondary btn-sm"><i
                        class="fas fa-times"></i> Close</button>
            </div>
            <div id="databaseTableContainer">
                <table id="databaseTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Supplier Name</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="overlay"></div>

        <canvas id="hiddenCanvas" style="display:none;"></canvas>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
       const firebaseConfig = {
          apiKey: "AIzaSyAqB5syqP1BVfA9dUx3A6zvokDw3oacy_E",
          authDomain: "data-base-2c8bf.firebaseapp.com",
          projectId: "data-base-2c8bf",
          storageBucket: "data-base-2c8bf.firebasestorage.app",
          messagingSenderId: "958395018379",
          appId: "1:958395018379:web:eb7588afda28e32e5a788e",
          measurementId: "G-PMJ02H7PK2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();


        let database = [];
        let entries = [];
        const googleSheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrRFFRPe_jrOrDZM58gRqxfsA0deD60_q2jkA7XJRRfJQ7IiBdIqNDN7JdMawjw/pub?output=csv";
        const LOCAL_STORAGE_ENTRIES_KEY = 'pricingAppEntries';

        function saveEntriesToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_ENTRIES_KEY, JSON.stringify(entries));
        }

        function loadEntriesFromLocalStorage() {
            const storedEntries = localStorage.getItem(LOCAL_STORAGE_ENTRIES_KEY);
            return storedEntries ? JSON.parse(storedEntries) : [];
        }

        function clearEntriesFromLocalStorage() {
            localStorage.removeItem(LOCAL_STORAGE_ENTRIES_KEY);
        }

        function showLoadingIndicator() {
            document.getElementById('loading-indicator').style.display = 'flex';
        }

        function hideLoadingIndicator() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        function displayMessage(message, isError = false) {
            const messageContainer = document.getElementById('message-container');
            messageContainer.textContent = message;
            messageContainer.className = isError ? 'error show' : 'show';
            messageContainer.style.display = 'block';
            setTimeout(() => {
                messageContainer.classList.remove('show');
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, 400);
            }, 3000);
        }

        function displayError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = '';
            }
        }


        function autoLoadDatabase() {
            showLoadingIndicator();
            fetch(googleSheetCsvUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.text();
                })
                .then(csvData => {
                    const newDatabase = parseCSV(csvData);
                    if (newDatabase.length > 0 && (!newDatabase[0].code || !newDatabase[0].name || !newDatabase[0]['supplier name'])) {
                        displayMessage('Google Sheet must have columns: code, name, and supplier name.', true);
                        return;
                    }
                    database = newDatabase;
                    displayMessage('Database auto-loaded successfully from Google Sheet!');
                })
                .catch(error => {
                    console.error('Error auto-loading database from Google Sheet:', error);
                    displayMessage(`Error auto-loading database: ${error.message}.`, true);
                })
                .finally(() => {
                    hideLoadingIndicator();
                });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim().toLowerCase().replace(/\r$/, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim().replace(/\r$/, ''));
                if (values.length === headers.length) {
                    const rowData = {};
                    for (let j = 0; j < headers.length; j++) {
                        rowData[headers[j]] = values[j];
                    }
                    data.push(rowData);
                }
            }
            return data;
        }


        window.onload = function () {
            loadEntriesFromLocalStorageAndUpdateTable();
            autoLoadDatabase();
            toggleCurrentPriceField();
        };

        function loadEntriesFromLocalStorageAndUpdateTable() {
            entries = loadEntriesFromLocalStorage();
            updateEntriesTable();
        }

        function viewDatabase() {
            const popup = document.getElementById('databasePopup');
            const overlay = document.getElementById('overlay');
            popup.classList.add('show');
            overlay.classList.add('show');
            popup.style.display = 'block';
            overlay.style.display = 'block';

            const tableBody = popup.querySelector('#databaseTable tbody');
            tableBody.innerHTML = '';
            if (database.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.textContent = "Database is empty or not loaded yet.";
                cell.style.textAlign = "center";
                return;
            }
            database.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.code || '';
                row.insertCell().textContent = item.name || '';
                row.insertCell().textContent = item['supplier name'] || '';
            });
        }

        function closeDatabasePopup() {
            const popup = document.getElementById('databasePopup');
            const overlay = document.getElementById('overlay');
            popup.classList.remove('show');
            overlay.classList.remove('show');
            setTimeout(() => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }

        async function clearDatabase() {
            if (confirm("Are you sure you want to clear the locally loaded database (from Google Sheet)? This will not affect the Google Sheet itself.")) {
                database = [];
                displayMessage('In-memory database (from Google Sheet) cleared!');
                const popupTableBody = document.querySelector('#databasePopup #databaseTable tbody');
                if (popupTableBody) {
                     popupTableBody.innerHTML = '';
                     const row = popupTableBody.insertRow();
                     const cell = row.insertCell();
                     cell.colSpan = 3;
                     cell.textContent = "Database is empty or not loaded yet.";
                     cell.style.textAlign = "center";
                }
            }
        }


        function getItemDetails() {
            const code = document.getElementById('code').value.trim();
            clearError('codeError');
            document.getElementById('name').value = '';
            document.getElementById('supplierName').value = '';

            if (!code) return;

            const foundItem = database.find(item => item.code === code);
            if (foundItem) {
                document.getElementById('name').value = foundItem.name || '';
                document.getElementById('supplierName').value = foundItem['supplier name'] || '';
            } else {
                displayMessage('Item details not found in the loaded database.', true);
            }
        }

        function toggleAlternateSupplier() {
            const checkBox = document.getElementById('alternateSupplierCheck');
            const alternateSupplierDiv = document.getElementById('alternateSupplierDiv');
            alternateSupplierDiv.style.display = checkBox.checked ? 'flex' : 'none';
        }

        function toggleCurrentPriceField() {
            const typeSelect = document.getElementById('type');
            const currentPriceDiv = document.getElementById('currentPriceDiv');
            currentPriceDiv.style.display = typeSelect.value === 'مرتجع' ? 'flex' : 'none';
        }

        function calculateTotal() {
            clearError('costError');
            clearError('vatError');
            clearError('currentPriceError');
            clearError('unitError');

            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const unit = parseInt(document.getElementById('unit').value) || 0;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const vatRate = parseFloat(document.getElementById('vat').value) || 0;

            let valid = true;
            if (cost < 0) {
                displayError('costError', 'Cost must be a non-negative number.');
                valid = false;
            }
            if (unit <= 0) {
                displayError('unitError', 'Units per case must be positive.');
                valid = false;
            }

            if (!valid) {
                document.getElementById('unitPrice').value = '';
                document.getElementById('casePrice').value = '';
                return;
            }

            let discountedCost = cost * (1 - discount / 100);
            let costWithVat = discountedCost * (1 + vatRate / 100);
            let unitPriceValue = (unit > 0) ? (costWithVat / unit) : 0;

            document.getElementById('unitPrice').value = unitPriceValue.toFixed(3);
            document.getElementById('casePrice').value = costWithVat.toFixed(3);
        }


        function addToList() {
            const code = document.getElementById('code').value.trim();
            const name = document.getElementById('name').value.trim();
            const supplierName = document.getElementById('supplierName').value.trim();
            const alternateSupplierCheck = document.getElementById('alternateSupplierCheck').checked;
            const alternateSupplierName = document.getElementById('alternateSupplierName').value.trim();
            const costInput = document.getElementById('cost').value;
            const unitInput = document.getElementById('unit').value;
            const discount = parseFloat(document.getElementById('discount').value);
            const vat = document.getElementById('vat').value;
            const unitPrice = document.getElementById('unitPrice').value;
            const casePrice = document.getElementById('casePrice').value;
            const type = document.getElementById('type').value;
            const currentPriceInput = document.getElementById('currentPrice').value;

            let isValid = true;
            clearError('codeError');
            clearError('costError');
            clearError('unitError');
            clearError('currentPriceError');


            if (!code) {
                displayError('codeError', 'Code is required.');
                isValid = false;
            }
            if (costInput === '' || isNaN(parseFloat(costInput)) || parseFloat(costInput) < 0) {
                displayError('costError', 'Valid case cost is required.');
                isValid = false;
            }
            const unit = parseInt(unitInput);
             if (isNaN(unit) || unit <= 0) {
                displayError('unitError', 'Valid units per case required (must be > 0).');
                isValid = false;
            }

            let currentFormatted = '';
            if (type === 'مرتجع') {
                if (currentPriceInput === '' || isNaN(parseFloat(currentPriceInput)) || parseFloat(currentPriceInput) < 0) {
                    displayError('currentPriceError', 'Valid current price is required for "مرتجع" type.');
                    isValid = false;
                } else {
                    currentFormatted = parseFloat(currentPriceInput).toFixed(3);
                }
            }

            if (!unitPrice || !casePrice) { // Check if calculations produced values
                displayMessage('Price calculations are incomplete. Please check inputs.', true);
                isValid = false;
            }


            if (!isValid) {
                displayMessage('Please correct the errors before saving.', true);
                return;
            }


            const entryData = {
                code: code,
                name: name,
                supplier: alternateSupplierCheck && alternateSupplierName ? alternateSupplierName : supplierName,
                units: unit,
                discount: isNaN(discount) ? 0 : discount,
                vat: vat,
                piece: unitPrice,
                case: casePrice,
                type: type,
                current: currentFormatted
            };

            entries.push(entryData);
            saveEntriesToLocalStorage();
            updateEntriesTable();
            displayMessage('Item added to local list.');
            clearInputFields();
        }

        function clearInputFields() {
            document.getElementById('code').value = '';
            document.getElementById('name').value = '';
            document.getElementById('supplierName').value = '';
            document.getElementById('alternateSupplierCheck').checked = false;
            document.getElementById('alternateSupplierName').value = '';
            document.getElementById('alternateSupplierDiv').style.display = 'none';
            document.getElementById('cost').value = '';
            document.getElementById('unit').value = '1';
            document.getElementById('discount').value = '0';
            document.getElementById('vat').value = '0';
            document.getElementById('unitPrice').value = '';
            document.getElementById('casePrice').value = '';
            document.getElementById('currentPrice').value = '';
            document.getElementById('type').value = 'شراء';
            toggleCurrentPriceField();


            clearError('codeError');
            clearError('costError');
            clearError('vatError');
            clearError('currentPriceError');
            clearError('unitError');
        }


        function updateEntriesTable() {
            const entriesTableBody = document.querySelector('#entriesTable tbody');
            entriesTableBody.innerHTML = '';

            entries.forEach((entry, index) => {
                const row = entriesTableBody.insertRow();
                row.insertCell().textContent = entry.code;
                row.insertCell().textContent = entry.name;
                row.insertCell().textContent = entry.supplier;
                row.insertCell().textContent = entry.units;
                row.insertCell().textContent = entry.discount;
                row.insertCell().textContent = entry.vat;
                row.insertCell().textContent = entry.piece;
                row.insertCell().textContent = entry.case;
                row.insertCell().textContent = entry.type;
                row.insertCell().textContent = entry.current;

                const actionsCell = row.insertCell();
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger btn-sm';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                deleteButton.onclick = () => deleteLocalEntry(index);
                actionsCell.appendChild(deleteButton);
            });
        }

        function deleteLocalEntry(index) {
            if (confirm("Are you sure you want to delete this entry from the local list?")) {
                entries.splice(index, 1);
                saveEntriesToLocalStorage();
                updateEntriesTable();
                displayMessage('Entry deleted from local list.');
            }
        }

        async function clearAll() {
             if (confirm("Are you sure you want to clear all entries from the local list?")) {
                clearEntriesFromLocalStorage();
                entries = [];
                updateEntriesTable();
                displayMessage('All local entries cleared.');
            }
        }

        function exportToExcel() {
            if (entries.length === 0) {
                displayMessage('No entries to export.', true);
                return;
            }

            try {
                const dataForExcel = entries.map(entry => {
                    return {
                        "Code": entry.code,
                        "Name": entry.name,
                        "Supplier": entry.supplier,
                        "Units": entry.units,
                        "Discount (%)": entry.discount,
                        "VAT (%)": entry.vat,
                        "Piece Price": entry.piece,
                        "Case Price": entry.case,
                        "Type": entry.type,
                        "Current Price": entry.current
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet(dataForExcel);

                const columnWidths = [];
                const header = Object.keys(dataForExcel[0] || {});
                header.forEach(key => {
                    let max_width = key.length;
                    dataForExcel.forEach(row => {
                         if (row[key] && row[key].toString().length > max_width) {
                            max_width = row[key].toString().length;
                        }
                    });
                    columnWidths.push({ wch: max_width + 2 });
                });
                worksheet['!cols'] = columnWidths;


                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Entries");

                XLSX.writeFile(workbook, "pricing_entries.xlsx");
                displayMessage('Entries exported to Excel successfully!');

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                displayMessage('Error exporting to Excel. Check console for details.', true);
            }
        }

        function exportToJPG() {
            console.log("exportToJPG function started");
            const table = document.getElementById('entriesTable');
            if (entries.length === 0) {
                displayMessage('No entries to export as JPG.', true);
                return;
            }

            const originalStyles = {};
            const tds = table.querySelectorAll('td');
            tds.forEach(td => {
                originalStyles[td] = {
                    whiteSpace: td.style.whiteSpace,
                    wordBreak: td.style.wordBreak,
                    textOverflow: td.style.textOverflow
                };
                td.style.whiteSpace = 'nowrap';
                td.style.wordBreak = 'normal';
                td.style.textOverflow = 'clip';
            });
            console.log("Before html2canvas call");

            html2canvas(table, {
                scale: 2,
                useCORS: true,
                logging: true,
                scrollY: window.scrollY * -1,
                scrollX: 0,
                windowWidth: document.body.scrollWidth,
                windowHeight: document.body.scrollHeight,
            }).then(canvas => {
                console.log("html2canvas .then block executed");
                try {
                    const imgData = canvas.toDataURL('image/jpeg', 0.9); // Already JPEG
                    const link = document.createElement('a');
                    link.href = imgData;
                    link.download = 'entries_table.jpg'; // Already .jpg
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    displayMessage('Table exported to JPG!');
                } catch (exportError) {
                    console.error('Error during JPG export:', exportError);
                    displayMessage('Error exporting to JPG. Check the console for details.', true);
                }
            }).finally(() => {
                console.log("html2canvas .finally block executed");
                tds.forEach(td => {
                    if (originalStyles[td]) {
                        td.style.whiteSpace = originalStyles[td].whiteSpace;
                        td.style.wordBreak = originalStyles[td].wordBreak;
                        td.style.textOverflow = originalStyles[td].textOverflow;
                    }
                });
            }).catch(error => {
                console.log("html2canvas .catch block executed", error);
                console.error('Error exporting to JPG:', error);
                displayMessage('Error exporting to JPG. Check the console for details.', true);
            });
            console.log("exportToJPG function finished (after html2canvas call)");
        }
    </script>
</body>
</html>
